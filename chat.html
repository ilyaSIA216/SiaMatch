<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç - Match –†–æ—Å—Å–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            max-width: 500px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid #f0f0f0;
        }
        
        .chat-item:hover {
            background: #f8f9fa;
        }
        
        .chat-item.active {
            background: #f0f7ff;
            border-color: #667eea;
        }
        
        .chat-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-right: 15px;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .chat-last-message {
            color: #666;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .chat-meta {
            text-align: right;
            font-size: 12px;
            color: #999;
        }
        
        .chat-time {
            margin-bottom: 5px;
        }
        
        .unread-badge {
            background: #4cd964;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* –û–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            margin-right: 15px;
            cursor: pointer;
            color: #333;
        }
        
        .chat-partner {
            flex: 1;
        }
        
        .chat-partner-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .chat-partner-status {
            font-size: 14px;
            color: #4cd964;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 70%;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-them {
            align-self: flex-start;
        }
        
        .message-you {
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 15px;
        }
        
        .message-them .message-content {
            background: white;
            border-bottom-left-radius: 5px;
        }
        
        .message-you .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }
        
        .chat-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
        }
        
        .chat-input input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* –ù–µ—Ç —á–∞—Ç–æ–≤ */
        .no-chats {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            color: #666;
        }
        
        .no-chats-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .no-chats-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .no-chats-text {
            margin-bottom: 30px;
            max-width: 300px;
            line-height: 1.5;
        }
        
        .find-match-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω */
        .access-denied {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            background: white;
        }
        
        .access-icon {
            font-size: 80px;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .access-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .access-text {
            color: #666;
            margin-bottom: 30px;
            max-width: 300px;
            line-height: 1.5;
        }
        
        .access-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            z-index: 1000;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app-container"></div>
    
    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const API_URL = 'https://laughing-space-fiesta-x57vjp5qgg4rc667v-3000.app.github.dev'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à API
        const tg = Telegram.WebApp;
        let currentChat = null;
        let messages = [];
        let chats = [];
        
        // ========== –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê ==========
        
        tg.expand();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
            showAccessDenied('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–æ—Ç–æ
        const photoStatus = localStorage.getItem('photo_status');
        if (photoStatus !== 'approved') {
            showAccessDenied('–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç–∞–º');
            return;
        }
        
        // ========== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ==========
        
        async function initApp() {
            showLoading(true);
            
            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                await loadChats();
                
                // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                if (chats.length === 0) {
                    showNoChats();
                } else {
                    renderChatsList();
                }
                
                // 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º WebSocket –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
                setupWebSocket();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤');
            } finally {
                showLoading(false);
            }
        }
        
        async function loadChats() {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å –∫ API
            // –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º—ç—Ç—á–∏
            
            const savedMatches = JSON.parse(localStorage.getItem('matches') || '[]');
            const savedMessages = JSON.parse(localStorage.getItem('chat_messages') || '{}');
            
            chats = savedMatches.map(match => {
                const chatId = `chat_${match.id}`;
                const chatMessages = savedMessages[chatId] || [];
                const lastMessage = chatMessages[chatMessages.length - 1];
                
                return {
                    id: match.id,
                    chatId: chatId,
                    name: match.name,
                    age: match.age,
                    city: match.city,
                    lastMessage: lastMessage ? lastMessage.text : '–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ',
                    lastTime: lastMessage ? lastMessage.time : new Date().toISOString(),
                    unread: 0
                };
            });
        }
        
        function setupWebSocket() {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
            // –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
            
            console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        }
        
        // ========== –†–ï–ù–î–ï–†–ò–ù–ì ==========
        
        function showLoading(show) {
            const container = document.getElementById('app-container');
            if (show) {
                container.innerHTML = `
                    <div class="loading">
                        <div class="loader"></div>
                        <p>–ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã...</p>
                    </div>
                `;
            }
        }
        
        function showAccessDenied(message) {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="access-denied">
                    <div class="access-icon">üîí</div>
                    <div class="access-title">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</div>
                    <div class="access-text">${message}</div>
                    
                    <button class="access-btn" onclick="goToMain()">
                        üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </button>
                    
                    ${photoStatus === 'none' ? `
                        <button class="access-btn" onclick="goToUploadPhoto()">
                            üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                        </button>
                    ` : ''}
                </div>
            `;
        }
        
        function showError(message) {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="access-denied">
                    <div class="access-icon">‚ö†Ô∏è</div>
                    <div class="access-title">–û—à–∏–±–∫–∞</div>
                    <div class="access-text">${message}</div>
                    
                    <button class="access-btn" onclick="location.reload()">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button class="access-btn" onclick="goToMain()">
                        üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </button>
                </div>
            `;
        }
        
        function showNoChats() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="container">
                    <div class="no-chats">
                        <div class="no-chats-icon">üí¨</div>
                        <div class="no-chats-title">–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div>
                        <div class="no-chats-text">
                            –ù–∞–π–¥–∏—Ç–µ –º—ç—Ç—á–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è.<br>
                            –ü—Ä–∏ –≤–∑–∞–∏–º–Ω–æ–º –ª–∞–π–∫–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —á–∞—Ç.
                        </div>
                        <button class="find-match-btn" onclick="goToSwipes()">
                            üî• –ù–∞–π—Ç–∏ –º—ç—Ç—á–∏
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderChatsList() {
            const container = document.getElementById('app-container');
            
            container.innerHTML = `
                <div class="container">
                    <div class="chats-list" id="chats-list">
                        ${chats.map(chat => `
                            <div class="chat-item" onclick="openChat('${chat.id}')" id="chat-${chat.id}">
                                <div class="chat-avatar">
                                    ${chat.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name">${chat.name}, ${chat.age}</div>
                                    <div class="chat-last-message">${chat.lastMessage}</div>
                                </div>
                                <div class="chat-meta">
                                    <div class="chat-time">${formatTime(chat.lastTime)}</div>
                                    ${chat.unread > 0 ? `
                                        <div class="unread-badge">${chat.unread}</div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderChatWindow(chatId) {
            const chat = chats.find(c => c.id == chatId);
            if (!chat) return;
            
            currentChat = chat;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
            loadMessages(chat.chatId);
            
            const container = document.getElementById('app-container');
            
            container.innerHTML = `
                <div class="container">
                    <div class="chat-window">
                        <div class="chat-header">
                            <button class="back-btn" onclick="backToChats()">‚Üê</button>
                            <div class="chat-partner">
                                <div class="chat-partner-name">${chat.name}, ${chat.age}</div>
                                <div class="chat-partner-status">–æ–Ω–ª–∞–π–Ω</div>
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="chat-messages">
                            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        
                        <div class="chat-input">
                            <input type="text" 
                                   id="message-input" 
                                   placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                   onkeypress="handleKeyPress(event)">
                            <button class="send-btn" onclick="sendMessage()" id="send-btn">
                                ‚Üë
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                document.getElementById('message-input').focus();
            }, 300);
        }
        
        async function loadMessages(chatId) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
            // –°–µ–π—á–∞—Å –∏–∑ localStorage
            
            const savedMessages = JSON.parse(localStorage.getItem('chat_messages') || '{}');
            messages = savedMessages[chatId] || [];
            
            renderMessages();
        }
        
        function renderMessages() {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            
            container.innerHTML = messages.map(msg => `
                <div class="message message-${msg.sender}">
                    <div class="message-content">${msg.text}</div>
                    <div class="message-time">${formatTime(msg.time)}</div>
                </div>
            `).join('');
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        // ========== –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê ==========
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !currentChat) return;
            
            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const message = {
                id: Date.now(),
                text: text,
                sender: 'you',
                time: new Date().toISOString(),
                chatId: currentChat.chatId
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
            messages.push(message);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            saveMessage(message);
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderMessages();
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            await sendMessageToServer(message);
        }
        
        async function sendMessageToServer(message) {
            try {
                // –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:
                // await fetch(`${API_URL}/api/messages`, {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //         'Authorization': `Bearer ${tg.initData}`
                //     },
                //     body: JSON.stringify(message)
                // });
                
                console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', message);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        }
        
        function saveMessage(message) {
            const savedMessages = JSON.parse(localStorage.getItem('chat_messages') || '{}');
            
            if (!savedMessages[message.chatId]) {
                savedMessages[message.chatId] = [];
            }
            
            savedMessages[message.chatId].push(message);
            localStorage.setItem('chat_messages', JSON.stringify(savedMessages));
        }
        
        function openChat(chatId) {
            renderChatWindow(chatId);
        }
        
        function backToChats() {
            initApp();
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 3600000) { // –ú–µ–Ω—å—à–µ —á–∞—Å–∞
                const mins = Math.floor(diff / 60000);
                return mins === 0 ? '—Ç–æ–ª—å–∫–æ —á—Ç–æ' : `${mins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            } else if (diff < 86400000) { // –ú–µ–Ω—å—à–µ —Å—É—Ç–æ–∫
                return date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                return date.toLocaleDateString('ru-RU');
            }
        }
        
        // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
        
        function goToMain() {
            window.location.href = 'app.html';
        }
        
        function goToUploadPhoto() {
            window.location.href = 'upload-photo.html';
        }
        
        function goToSwipes() {
            window.location.href = 'swipes.html';
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
