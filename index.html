// ========== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
const API_URL = 'https://laughing-space-fiesta-x57vjp5qgg4rc667v-3000.app.github.dev';

// ========== –ú–û–ö TELEGRAM –î–õ–Ø –ë–†–ê–£–ó–ï–†–ê ==========
if (!window.Telegram || !Telegram.WebApp) {
    console.log('‚ö†Ô∏è –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: –ò–º–∏—Ç–∏—Ä—É–µ–º Telegram WebApp');
    
    window.Telegram = {
        WebApp: {
            initDataUnsafe: {
                user: {
                    id: 123456789,
                    username: 'test_user',
                    first_name: '–ò–≤–∞–Ω',
                    last_name: '–¢–µ—Å—Ç–æ–≤—ã–π'
                }
            },
            expand: function() { console.log('[DEBUG] Telegram expanded') },
            ready: function() { console.log('[DEBUG] Telegram ready') },
            showAlert: function(msg) { 
                console.log('[DEBUG] Alert:', msg);
                alert(msg);
            },
            showConfirm: function(msg, callback) {
                console.log('[DEBUG] Confirm:', msg);
                if (confirm(msg + ' (OK=–î–∞, Cancel=–ù–µ—Ç)')) {
                    callback(true);
                } else {
                    callback(false);
                }
            }
        }
    };
}

const tg = window.Telegram.WebApp;

let userProfile = {
    telegramId: null,
    username: null,
    firstName: null,
    age: null,
    city: null,
    mainPhoto: null,
    selfiePhoto: null
};

// ========== –°–ü–ò–°–ö–ò –î–ê–ù–ù–´–• ==========
const russianCities = [
    "–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥",
    "–ö–∞–∑–∞–Ω—å", "–ß–µ–ª—è–±–∏–Ω—Å–∫", "–û–º—Å–∫", "–°–∞–º–∞—Ä–∞", "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É", "–£—Ñ–∞", "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫"
].sort((a, b) => a.localeCompare(b, 'ru'));

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
async function initApp() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    
    try {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
        tg.expand();
        tg.ready();
        console.log('‚úÖ Telegram –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        
        // 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const tgUser = tg.initDataUnsafe?.user;
        console.log('üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram:', tgUser);
        
        if (!tgUser) {
            console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ');
            userProfile.telegramId = 'test_' + Date.now();
            userProfile.username = 'test_user';
        } else {
            userProfile.telegramId = tgUser.id;
            userProfile.username = tgUser.username || '';
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–º—è –≤ Telegram - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if (tgUser.first_name) {
                userProfile.firstName = tgUser.first_name;
                document.getElementById('name-input').value = tgUser.first_name;
            }
        }
        
        // 3. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        displayWelcome(tgUser);
        
        // 4. –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∫–∏
        populateAgeSelect();
        populateCitySelect();
        
        console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ');
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' + error.message);
    }
}

function displayWelcome(tgUser) {
    const welcomeText = document.getElementById('welcome-text');
    const userAvatar = document.getElementById('user-avatar');
    
    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º
    if (tgUser && tgUser.first_name) {
        welcomeText.textContent = `–ü—Ä–∏–≤–µ—Ç, ${tgUser.first_name}!`;
    } else {
        welcomeText.textContent = '–ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SiaMatch!';
    }
    
    // –ê–≤–∞—Ç–∞—Ä
    if (tgUser && tgUser.first_name) {
        userAvatar.textContent = tgUser.first_name.charAt(0).toUpperCase();
    } else {
        userAvatar.textContent = 'üë§';
    }
}

function populateAgeSelect() {
    const select = document.getElementById('age-select');
    console.log('–ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤...');
    
    // –û—á–∏—â–∞–µ–º
    while (select.firstChild) {
        select.removeChild(select.firstChild);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º placeholder
    const placeholder = document.createElement('option');
    placeholder.value = "";
    placeholder.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç";
    placeholder.disabled = true;
    placeholder.selected = true;
    select.appendChild(placeholder);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç–∞ 18-60
    for (let age = 18; age <= 60; age++) {
        const option = document.createElement('option');
        option.value = age;
        option.textContent = `${age} –ª–µ—Ç`;
        select.appendChild(option);
    }
    
    console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${select.options.length - 1} –≤–æ–∑—Ä–∞—Å—Ç–æ–≤`);
}

function populateCitySelect() {
    const select = document.getElementById('city-select');
    console.log('–ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤...');
    
    // –û—á–∏—â–∞–µ–º
    while (select.firstChild) {
        select.removeChild(select.firstChild);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º placeholder
    const placeholder = document.createElement('option');
    placeholder.value = "";
    placeholder.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥";
    placeholder.disabled = true;
    placeholder.selected = true;
    select.appendChild(placeholder);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥–∞
    russianCities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        select.appendChild(option);
    });
    
    console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${select.options.length - 1} –≥–æ—Ä–æ–¥–æ–≤`);
}

// ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
function goToStep(stepNumber) {
    console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É ${stepNumber}`);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
    for (let i = 0; i <= 7; i++) {
        document.getElementById(`step-${i}`).classList.add('hidden');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —à–∞–≥
    document.getElementById(`step-${stepNumber}`).classList.remove('hidden');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    updateProgressIndicator(stepNumber);
}

function updateProgressIndicator(currentStep) {
    if (currentStep < 1 || currentStep > 5) return;
    
    const indicators = document.querySelectorAll('.step-dot');
    indicators.forEach((dot, index) => {
        if (index < currentStep) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
}

function startOnboarding() {
    console.log('–ù–∞—á–∞–ª–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞');
    goToStep(1);
}

// ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ==========
function saveName() {
    const name = document.getElementById('name-input').value.trim();
    console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è:', name);
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
        return;
    }
    
    if (name.length < 2) {
        alert('–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
        return;
    }
    
    userProfile.firstName = name;
    goToStep(2);
}

function saveAge() {
    const ageSelect = document.getElementById('age-select');
    const age = parseInt(ageSelect.value);
    
    console.log('–í—ã–±—Ä–∞–Ω –≤–æ–∑—Ä–∞—Å—Ç:', age, '–ò–∑ —ç–ª–µ–º–µ–Ω—Ç–∞:', ageSelect);
    
    if (!age || age < 18 || age > 60) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –æ—Ç 18 –¥–æ 60 –ª–µ—Ç');
        
        // –ü–æ–∫–∞–∂–µ–º —á—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ
        console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏:');
        for (let i = 0; i < ageSelect.options.length; i++) {
            console.log(`  ${i}: ${ageSelect.options[i].value} - ${ageSelect.options[i].text}`);
        }
        
        return;
    }
    
    userProfile.age = age;
    console.log('–í–æ–∑—Ä–∞—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', userProfile.age);
    goToStep(3);
}

function saveCity() {
    const citySelect = document.getElementById('city-select');
    const city = citySelect.value;
    
    console.log('–í—ã–±—Ä–∞–Ω –≥–æ—Ä–æ–¥:', city, '–ò–∑ —ç–ª–µ–º–µ–Ω—Ç–∞:', citySelect);
    
    if (!city) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥');
        return;
    }
    
    userProfile.city = city;
    goToStep(4);
}

// ========== –†–ê–ë–û–¢–ê –° –§–û–¢–û ==========
function previewMainPhoto(event) {
    const file = event.target.files[0];
    console.log('–í—ã–±—Ä–∞–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ:', file);
    
    if (!file) return;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('–§–æ—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ 5MB');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('main-photo-preview');
        preview.src = e.target.result;
        preview.classList.remove('hidden');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
        userProfile.mainPhoto = e.target.result;
        console.log('–û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
    };
    
    reader.readAsDataURL(file);
}

function previewSelfie(event) {
    const file = event.target.files[0];
    console.log('–í—ã–±—Ä–∞–Ω–æ —Å–µ–ª—Ñ–∏:', file);
    
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('selfie-preview');
        preview.src = e.target.result;
        preview.classList.remove('hidden');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
        userProfile.selfiePhoto = e.target.result;
        console.log('–°–µ–ª—Ñ–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
    };
    
    reader.readAsDataURL(file);
}

function saveMainPhoto() {
    if (!userProfile.mainPhoto) {
        alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ');
        return;
    }
    
    console.log('–û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    goToStep(5);
}

async function saveSelfie() {
    if (!userProfile.selfiePhoto) {
        alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ–ª—Ñ–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
        return;
    }
    
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö...');
    goToStep(6);
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        await sendRegistrationData();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('sia_match_profile', JSON.stringify({
            ...userProfile,
            status: 'pending',
            registeredAt: new Date().toISOString()
        }));
        
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–∂–∏–¥–∞–Ω–∏—é');
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫—Ä–∞–Ω—É –æ–∂–∏–¥–∞–Ω–∏—è
        setTimeout(() => {
            goToStep(7);
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message + '\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)');
        goToStep(5);
    }
}

// ========== –û–¢–ü–†–ê–í–ö–ê –ù–ê –°–ï–†–í–ï–† ==========
async function sendRegistrationData() {
    console.log('üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
    
    try {
        const registrationData = {
            telegramId: userProfile.telegramId || 'test_' + Date.now(),
            username: userProfile.username || '',
            firstName: userProfile.firstName,
            age: userProfile.age,
            city: userProfile.city,
            gender: 'not_specified'
        };
        
        console.log('üì§ –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', registrationData);
        console.log('üéØ URL:', `${API_URL}/api/register`);
        
        const response = await fetch(`${API_URL}/api/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(registrationData)
        });
        
        console.log('üì• –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        
        const result = await response.json();
        console.log('‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
        
        if (!result.success) {
            throw new Error(result.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
        console.log('üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
        return result;
        
    } catch (error) {
        console.error('üî• –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        localStorage.setItem('sia_match_profile', JSON.stringify({
            ...userProfile,
            status: 'pending_offline',
            registeredAt: new Date().toISOString(),
            error: error.message
        }));
        
        throw error;
    }
}

// ========== –ó–ê–ü–£–°–ö ==========
document.addEventListener('DOMContentLoaded', initApp);

// –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
window.startOnboarding = startOnboarding;
window.goToStep = goToStep;
window.saveName = saveName;
window.saveAge = saveAge;
window.saveCity = saveCity;
window.saveMainPhoto = saveMainPhoto;
window.saveSelfie = saveSelfie;
window.previewMainPhoto = previewMainPhoto;
window.previewSelfie = previewSelfie;
